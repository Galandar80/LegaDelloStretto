<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Inserimento Scheda - Deck List</title>
    <style>
        :root {
            --bg: #0f172a; --panel: #111827; --muted: #94a3b8; --text: #e5e7eb; --primary:#2563eb; --primary-700:#1d4ed8; --danger:#ef4444; --success:#10b981; --ring: rgba(37,99,235,.35); --radius:12px;
        }
        * { box-sizing: border-box; }
        html, body { height:100%; margin:0; background: radial-gradient(1200px 800px at 10% 0%, #0b1220 0%, var(--bg) 60%), radial-gradient(1000px 700px at 100% 100%, #0b1220 0%, var(--bg) 60%); color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial; }
        .container { max-width: 900px; margin: 0 auto; padding: 24px 16px 40px; }
        .panel { background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.01)); border:1px solid rgba(255,255,255,0.06); border-radius: var(--radius); box-shadow: 0 10px 30px rgba(0,0,0,.35); }
        header { display:flex; align-items:center; justify-content:space-between; margin-bottom: 16px; }
        .title { font-weight:800; font-size:1.5rem; }
        .field { display:flex; flex-direction:column; gap:6px; }
        label { color: var(--muted); font-size:.9rem; }
        input[type="text"], input[type="file"] { background:#0a0f1a; border:1px solid rgba(255,255,255,.08); color:var(--text); padding:10px 12px; border-radius:10px; outline:none; }
        input[type="text"]:focus, input[type="file"]:focus { border-color: var(--primary); box-shadow: 0 0 0 4px var(--ring); }
        .btn { appearance:none; border:none; color:white; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:600; }
        .btn-primary { background: var(--primary); }
        .btn-primary:hover { background: var(--primary-700); }
        .btn-secondary { background: #334155; }
        .hint { color: var(--muted); font-size:.85rem; }
        .error { color: var(--danger); font-size:.9rem; }
        .success { color: var(--success); font-size:.9rem; }
        form { padding:16px; display:grid; grid-template-columns:1fr 1fr; gap:12px 16px; }
        @media (max-width:760px){ form{ grid-template-columns:1fr; } }
        .actions { grid-column:1 / -1; display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
        .preview { grid-column:1 / -1; display:flex; gap:12px; align-items:center; }
        .preview img { width:120px; height:120px; border-radius:12px; object-fit:cover; border:1px solid rgba(255,255,255,.08); background:#0a0f1a; }
        .banner { margin-top: 10px; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.06); }
        .banner.error { background: rgba(239,68,68,.1); }
        .banner.success { background: rgba(16,185,129,.1); }
        .codeBox { display:flex; gap:8px; align-items:center; }
        .codeOut { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background:#0a0f1a; border:1px dashed rgba(255,255,255,.18); padding:8px 10px; border-radius:8px; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="title">Inserimento Scheda</div>
        </header>

        <section class="panel" style="margin-bottom: 12px;" aria-labelledby="lookupTitle">
            <div style="padding:12px; display:grid; grid-template-columns: 1fr auto; gap: 10px; align-items:end;">
                <div class="field">
                    <label for="codeInput">Inserisci codice scheda per visualizzare/modificare</label>
                    <input id="codeInput" type="text" placeholder="Incolla codice (ID) della scheda" />
                </div>
                <button id="loadBtn" class="btn btn-secondary">Carica</button>
            </div>
        </section>

        <section class="panel" aria-labelledby="formTitle">
            <form id="cardForm" novalidate>
                <h2 id="formTitle" class="sr-only">Crea o modifica scheda</h2>
                <input type="hidden" id="editingId" value="" />

                <div class="field">
                    <label for="nome">Nome <span class="error" aria-hidden="true">*</span></label>
                    <input id="nome" type="text" placeholder="Inserisci nome" required />
                    <div id="nomeError" class="error" aria-live="polite"></div>
                </div>
                <div class="field">
                    <label for="cognome">Cognome <span class="error" aria-hidden="true">*</span></label>
                    <input id="cognome" type="text" placeholder="Inserisci cognome" required />
                    <div id="cognomeError" class="error" aria-live="polite"></div>
                </div>
                <div class="field" style="grid-column:1 / -1;">
                    <label for="torneo">Torneo (opzionale)</label>
                    <input id="torneo" type="text" placeholder="Inserisci il nome del torneo (opzionale)" />
                </div>
                <div class="field" style="grid-column:1 / -1;">
                    <label for="immagine">Immagine Deck List (JPG/PNG) <span class="hint">Max 10MB</span></label>
                    <input id="immagine" type="file" accept="image/*" />
                    <div id="immagineError" class="error" aria-live="polite"></div>
                    <div id="uploadStatus" class="hint" style="margin-top:6px; display:none;">Caricamento...</div>
                    <div id="uploadProgress" style="height:4px; background:#1f2937; border-radius:2px; overflow:hidden; display:none;">
                        <div id="uploadProgressBar" style="height:100%; width:0%; background:#2563eb; transition: width .25s;"></div>
                    </div>
                </div>
                <div class="preview" id="previewWrapper" hidden>
                    <img id="previewImg" alt="Anteprima immagine" />
                    <div class="hint">Anteprima immagine caricata</div>
                </div>
                <div class="actions">
                    <button type="submit" class="btn btn-primary" id="submitBtn">Salva scheda</button>
                    <button type="button" class="btn btn-secondary" id="resetBtn">Reset</button>
                    <div class="hint">Dopo il salvataggio ti verrà mostrato il codice della scheda.</div>
                </div>
                <div id="formFeedback" class="banner" hidden aria-live="polite"></div>
            </form>
        </section>

        <section id="codeSection" class="panel" style="margin-top:12px; display:none;" aria-labelledby="codeTitle">
            <div style="padding:12px; display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
                <div>
                    <div class="hint" id="codeTitle">Codice della scheda (usa per visualizzare/modificare):</div>
                    <div id="codeValue" class="codeOut"></div>
                </div>
                <div style="display:flex; gap:8px;">
                    <button id="copyCodeBtn" class="btn btn-secondary">Copia codice</button>
                    <button id="openImageBtn" class="btn btn-primary">Apri immagine</button>
                </div>
            </div>
        </section>
    </div>

    <!-- Modal immagine grande -->
    <div id="modal" aria-hidden="true" style="position:fixed; inset:0; display:none; align-items:center; justify-content:center; background: rgba(0,0,0,0.8); z-index:1000;">
        <div class="panel" role="dialog" aria-modal="true" style="max-width: 95vw; max-height: 95vh; border-radius:12px; overflow:hidden;">
            <div style="display:flex; justify-content:flex-end; gap:8px; padding:10px; border-bottom:1px solid rgba(255,255,255,.06);">
                <button id="closeBtn" class="btn btn-secondary">Chiudi</button>
            </div>
            <div style="padding: 10px; background:#0a0f1a; display:flex; align-items:center; justify-content:center;">
                <img id="modalImg" alt="Immagine grande" style="max-width: 90vw; max-height: 80vh; border-radius:12px;" />
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // ===== IndexedDB shared config (uguale all'altra app) =====
        const SUPABASE_URL = "https://gjptnqegyqbsmnywigqj.supabase.co";
        const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdqcHRucWVneXFic21ueXdpZ3FqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1Mzk1NDMsImV4cCI6MjA3NjExNTU0M30.Yx4dGkGh2tBTW1e_8yRxnO9geJ9_0tMiXMuhHGugsC4";
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
        const MAX_IMAGE_BYTES = 10 * 1024 * 1024;

        async function dbGet(id) {
            const { data, error } = await supabase.from('cards').select('*').eq('id', id).single();
            if (error) return null;
            return data;
        }
        async function dbPut(card) {
            // upsert row
            const { error } = await supabase.from('cards').upsert(card, { onConflict: 'id' });
            if (error) throw error;
        }

        // ===== Utils =====
        function generateId() { return `${Date.now()}_${Math.random().toString(36).slice(2,9)}`; }
        function showFeedback(message, type) {
            const el = document.getElementById("formFeedback");
            el.textContent = message; el.className = `banner ${type}`; el.hidden = false;
            window.clearTimeout(el._t); el._t = window.setTimeout(() => (el.hidden = true), 4000);
        }
        function clearFormErrors(){ nomeError.textContent = ""; cognomeError.textContent = ""; immagineError.textContent = ""; }
        function validateForm(){
            clearFormErrors();
            const nome = nomeInput.value.trim(); const cognome = cognomeInput.value.trim();
            let valid = true; if(!nome){ nomeError.textContent = "Il nome è obbligatorio."; valid = false; }
            if(!cognome){ cognomeError.textContent = "Il cognome è obbligatorio."; valid = false; }
            return valid;
        }
        function fileToBase64(file){
            return new Promise((resolve, reject)=>{
                if(!file) return resolve("");
                if(file.size > MAX_IMAGE_BYTES) return reject(new Error("L'immagine supera il limite di 10MB."));
                if(!file.type.startsWith("image/")) return reject(new Error("Il file selezionato non è un'immagine valida."));
                const reader = new FileReader(); reader.onload = () => resolve(reader.result); reader.onerror = () => reject(new Error("Errore durante la lettura dell'immagine.")); reader.readAsDataURL(file);
            });
        }
        function resetForm(){ cardForm.reset(); editingId.value = ""; submitBtn.textContent = "Salva scheda"; previewWrapper.hidden = true; clearFormErrors(); }

        // ===== Elementi =====
        const cardForm = document.getElementById("cardForm");
        const nomeInput = document.getElementById("nome");
        const cognomeInput = document.getElementById("cognome");
        const torneoInput = document.getElementById("torneo");
        const imgInput = document.getElementById("immagine");
        const nomeError = document.getElementById("nomeError");
        const cognomeError = document.getElementById("cognomeError");
        const immagineError = document.getElementById("immagineError");
        const previewWrapper = document.getElementById("previewWrapper");
        const previewImg = document.getElementById("previewImg");
        const submitBtn = document.getElementById("submitBtn");
        const editingId = document.getElementById("editingId");
        const codeSection = document.getElementById("codeSection");
        const codeValue = document.getElementById("codeValue");
        const copyCodeBtn = document.getElementById("copyCodeBtn");
        const codeInput = document.getElementById("codeInput");
        const loadBtn = document.getElementById("loadBtn");
        const openImageBtn = document.getElementById("openImageBtn");
        const modal = document.getElementById("modal");
        const modalImg = document.getElementById("modalImg");
        const closeBtn = document.getElementById("closeBtn");

        function openModalWithImage(src){ if(!src){ showFeedback("Nessuna immagine disponibile.", "error"); return; } modalImg.src = src; modal.style.display = "flex"; modal.setAttribute("aria-hidden","false"); }
        function closeModal(){ modal.style.display = "none"; modal.setAttribute("aria-hidden","true"); }
        closeBtn.addEventListener("click", closeModal);
        modal.addEventListener("click", (e)=>{ if(e.target === modal) closeModal(); });

        imgInput.addEventListener("change", async ()=>{
            immagineError.textContent = "";
            const file = imgInput.files && imgInput.files[0];
            if(!file){ previewWrapper.hidden = true; previewImg.removeAttribute("src"); return; }
            try{
                if(file.size > MAX_IMAGE_BYTES) throw new Error("L'immagine supera il limite di 10MB.");
                if(!file.type.startsWith("image/")) throw new Error("Il file selezionato non è un'immagine valida.");
                const base64 = await fileToBase64(file);
                previewImg.src = base64; previewWrapper.hidden = false;
            }catch(err){ previewWrapper.hidden = true; previewImg.removeAttribute("src"); immagineError.textContent = err.message || String(err); showFeedback(err.message || "Errore immagine.", "error"); imgInput.value = ""; }
        });

        cardForm.addEventListener("submit", async (e)=>{
            e.preventDefault(); if(!validateForm()){ showFeedback("Compila correttamente i campi obbligatori.", "error"); return; }
            const nome = nomeInput.value.trim(); const cognome = cognomeInput.value.trim(); const torneo = torneoInput.value.trim();
            let imageUrl = "";
            let deleteHash = null;
            try{
                const file = imgInput.files && imgInput.files[0];
                if(file){
                    const up = await uploadToImgur(file);
                    imageUrl = up.link; deleteHash = up.deletehash;
                } else if(editingId.value){ const ex = await dbGet(editingId.value); imageUrl = ex?.image_url || ex?.image_base64 || ""; deleteHash = ex?.delete_hash || null; }
            }catch(err){ immagineError.textContent = err.message || String(err); showFeedback(err.message || "Errore immagine.", "error"); return; }

            if(editingId.value){
                const id = editingId.value; const existing = await dbGet(id); if(!existing){ showFeedback("Codice non valido o scheda inesistente.", "error"); return; }
                // se sto sostituendo l'immagine e ho un delete_hash precedente, rimuovila
                if (deleteHash && existing?.delete_hash && deleteHash !== existing.delete_hash) {
                    try { await deleteFromImgur(existing.delete_hash); } catch (_) {}
                }
                const updated = { ...existing, nome, cognome, torneo, image_url: imageUrl, delete_hash: deleteHash || existing?.delete_hash || null };
                await dbPut(updated);
                showFeedback("Scheda aggiornata con successo.", "success");
                codeSection.style.display = "block"; codeValue.textContent = id;
                alert(`IMPORTANTE:\nSalva questo codice per visualizzare o modificare la scheda in futuro:\n\n${id}`);
            } else {
                const id = generateId();
                if ((imgInput.files || []).length) {
                    const file = imgInput.files[0];
                    const up = await uploadToImgur(file);
                    imageUrl = up.link; deleteHash = up.deletehash;
                }
                const card = { id, nome, cognome, torneo, image_url: imageUrl, delete_hash: deleteHash };
                await dbPut(card);
                showFeedback("Scheda creata con successo.", "success");
                codeSection.style.display = "block"; codeValue.textContent = id;
                alert(`IMPORTANTE:\nSalva questo codice per visualizzare o modificare la scheda in futuro:\n\n${id}`);
                resetForm();
            }
        });

        copyCodeBtn.addEventListener("click", async ()=>{
            try{ await navigator.clipboard.writeText(codeValue.textContent || ""); showFeedback("Codice copiato negli appunti.", "success"); } catch(_){ showFeedback("Impossibile copiare il codice.", "error"); }
        });
        document.getElementById("resetBtn").addEventListener("click", resetForm);

        // Upload/Deletion Imgur (scope globale)
        async function uploadToImgur(file){
            const clientId = '06127cb96dfdf99';
            const fd = new FormData(); fd.append('image', file);
            const statusEl = document.getElementById('uploadStatus');
            const barWrap = document.getElementById('uploadProgress');
            const bar = document.getElementById('uploadProgressBar');
            if (statusEl && barWrap && bar) { statusEl.style.display = 'block'; barWrap.style.display = 'block'; bar.style.width = '0%'; statusEl.textContent = 'Caricamento su Imgur...'; }
            let progress = 0; const timer = setInterval(() => { progress = Math.min(90, progress + 5); if (bar) bar.style.width = progress + '%'; }, 120);
            const res = await fetch('https://api.imgur.com/3/image', { method:'POST', headers:{ 'Authorization': `Client-ID ${clientId}` }, body: fd });
            const data = await res.json();
            clearInterval(timer);
            if (data && data.success && data.data && data.data.link) {
                if (bar && barWrap && statusEl) { bar.style.width = '100%'; statusEl.textContent = 'Caricamento completato!'; setTimeout(() => { barWrap.style.display = 'none'; statusEl.style.display = 'none'; }, 1200); }
                return { link: data.data.link, deletehash: data.data.deletehash };
            }
            if (statusEl) statusEl.textContent = 'Errore upload';
            throw new Error('Upload Imgur fallito');
        }

        async function deleteFromImgur(deleteHash){
            const clientId = '06127cb96dfdf99';
            await fetch(`https://api.imgur.com/3/image/${deleteHash}`, { method:'DELETE', headers:{ 'Authorization': `Client-ID ${clientId}` } });
        }

        loadBtn.addEventListener("click", async ()=>{
            const id = (codeInput.value || "").trim(); if(!id){ showFeedback("Inserisci un codice valido.", "error"); return; }
            const card = await dbGet(id);
            if(!card){ showFeedback("Nessuna scheda trovata per questo codice.", "error"); return; }
            editingId.value = id; submitBtn.textContent = "Salva Modifiche";
            nomeInput.value = card.nome || ""; cognomeInput.value = card.cognome || ""; torneoInput.value = card.torneo || "";
            if(card.image_url || card.image_base64){ previewImg.src = card.image_url || card.image_base64; previewWrapper.hidden = false; } else { previewWrapper.hidden = true; previewImg.removeAttribute("src"); }
            showFeedback("Scheda caricata. Ora puoi modificarla e salvare.", "success");
            codeSection.style.display = "block"; codeValue.textContent = id;
        });

        // Apertura immagine grande: dal bottone o clic sulla preview
        openImageBtn.addEventListener("click", ()=> openModalWithImage(previewImg.getAttribute("src")));
        previewWrapper.addEventListener("click", ()=> openModalWithImage(previewImg.getAttribute("src")));
    </script>
</body>
</html>


