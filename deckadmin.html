<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Schede Deck List</title>
    <link rel="stylesheet" href="assets/css/one-piece-styles.css">
    <script>
        if (sessionStorage.getItem('adminAuthenticated') !== 'true') {
            window.location.href = 'admin-login.html';
        }
    </script>
    <style>
        /*
         * Stili globali
         */
        :root {
            --bg: #0f172a;
            /* slate-900 */
            --panel: #111827;
            /* gray-900 */
            --muted: #94a3b8;
            /* slate-400 */
            --text: #e5e7eb;
            /* gray-200 */
            --primary: #2563eb;
            /* blue-600 */
            --primary-700: #1d4ed8;
            /* blue-700 */
            --danger: #ef4444;
            /* red-500 */
            --danger-700: #b91c1c;
            /* red-700 */
            --success: #10b981;
            /* emerald-500 */
            --warning: #f59e0b;
            /* amber-500 */
            --card: #0b1220;
            /* dark panel */
            --ring: rgba(37, 99, 235, 0.35);
            --radius: 12px;
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
        }

        * {
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
            margin: 0;
            background: radial-gradient(1200px 800px at 10% 0%, #0b1220 0%, var(--bg) 60%),
                radial-gradient(1000px 700px at 100% 100%, #0b1220 0%, var(--bg) 60%);
            color: var(--text);
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 24px 16px 40px;
        }

        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .title {
            font-weight: 800;
            font-size: 1.6rem;
            letter-spacing: 0.3px;
        }

        .panel {
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.04), rgba(255, 255, 255, 0.01));
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        /*
         * Form
         */
        form#cardForm {
            padding: 16px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px 16px;
        }

        .field {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .field label {
            font-size: 0.9rem;
            color: var(--muted);
        }

        .field input[type="text"],
        .field input[type="file"] {
            background: #0a0f1a;
            border: 1px solid rgba(255, 255, 255, 0.08);
            color: var(--text);
            padding: 10px 12px;
            border-radius: 10px;
            outline: none;
        }

        .field input[type="text"]:focus,
        .field input[type="file"]:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px var(--ring);
        }

        .actions {
            grid-column: 1 / -1;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .btn {
            appearance: none;
            border: none;
            color: white;
            padding: 10px 14px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.08s ease, background-color 0.15s ease, box-shadow 0.15s ease;
        }

        .btn:active {
            transform: translateY(1px);
        }

        .btn-primary {
            background: var(--primary);
        }

        .btn-primary:hover {
            background: var(--primary-700);
        }

        .btn-secondary {
            background: #334155;
        }

        .btn-secondary:hover {
            background: #1f2937;
        }

        .btn-danger {
            background: var(--danger);
        }

        .btn-danger:hover {
            background: var(--danger-700);
        }

        .hint {
            color: var(--muted);
            font-size: 0.85rem;
        }

        .error {
            color: var(--danger);
            font-size: 0.9rem;
        }

        .success {
            color: var(--success);
            font-size: 0.9rem;
        }

        .preview {
            grid-column: 1 / -1;
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .preview img {
            width: 120px;
            height: 120px;
            object-fit: cover;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            background: #0a0f1a;
        }

        /*
         * Griglia delle card
         */
        .grid {
            margin-top: 20px;
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 16px;
        }

        @media (max-width: 1080px) {
            .grid {
                grid-template-columns: repeat(8, 1fr);
            }
        }

        @media (max-width: 760px) {
            form#cardForm {
                grid-template-columns: 1fr;
            }

            .grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        @media (max-width: 420px) {
            .grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .card {
            grid-column: span 3;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.04), rgba(255, 255, 255, 0.02));
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 14px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow);
            transition: transform 0.12s ease, box-shadow 0.2s ease, border-color 0.2s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            border-color: rgba(37, 99, 235, 0.35);
        }

        .card img {
            width: 100%;
            height: 180px;
            object-fit: cover;
            background: #0a0f1a;
        }

        .card-body {
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .card-title {
            font-weight: 700;
            font-size: 1.05rem;
        }

        .card-sub {
            color: var(--muted);
            font-size: 0.9rem;
        }

        .card-actions {
            display: flex;
            gap: 8px;
        }

        /* Banner feedback */
        .banner {
            margin: 12px 0 0;
            padding: 10px 12px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.06);
        }

        .banner.error {
            background: rgba(239, 68, 68, 0.1);
        }

        .banner.success {
            background: rgba(16, 185, 129, 0.1);
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <div style="display:flex; gap:15px; align-items:center;">
                <a href="admin-dashboard.html" class="btn btn-secondary" style="text-decoration:none;">Dashboard</a>
                <div class="title">Gestione Schede - Deck List</div>
            </div>
            <button id="clearAllBtn" class="btn btn-secondary" title="Svuota tutto">Svuota Tutto</button>
        </header>

        <section class="panel" style="margin-bottom: 16px;" aria-labelledby="toolsTitle">
            <h2 id="toolsTitle" class="sr-only">Strumenti di consultazione</h2>
            <div id="toolbar" style="display:flex; flex-wrap: wrap; gap: 12px; align-items: center; padding: 12px;">
                <div style="flex: 1 1 220px; min-width: 200px;" class="field">
                    <label for="searchInput">Cerca per nome o cognome</label>
                    <input id="searchInput" type="text" placeholder="Digita per filtrare..." />
                </div>
                <div style="flex: 0 0 220px;" class="field">
                    <label for="sortSelect">Ordina</label>
                    <select id="sortSelect"
                        style="background:#0a0f1a; border:1px solid rgba(255,255,255,0.08); color:var(--text); padding:10px 12px; border-radius:10px;">
                        <option value="recent-desc">Più recenti</option>
                        <option value="recent-asc">Più vecchi</option>
                        <option value="nome-asc">Nome A→Z</option>
                        <option value="nome-desc">Nome Z→A</option>
                        <option value="cognome-asc">Cognome A→Z</option>
                        <option value="cognome-desc">Cognome Z→A</option>
                    </select>
                </div>

                <div id="resultsInfo" class="hint" style="margin-left:auto;">0 risultati</div>
                <div style="display:flex; gap:8px;">
                    <button id="exportBtn" class="btn btn-secondary" title="Esporta JSON">Esporta</button>
                    <label for="importInput" class="btn btn-primary"
                        style="display:inline-flex; align-items:center; cursor:pointer;">Importa
                        <input id="importInput" type="file" accept="application/json" style="display:none;" />
                    </label>
                </div>
            </div>
        </section>

        <section class="panel" aria-labelledby="formTitle">
            <form id="cardForm" novalidate>
                <h2 id="formTitle" class="sr-only">Crea o modifica scheda</h2>

                <input type="hidden" id="editingId" value="" />

                <div class="field">
                    <label for="nome">Nome <span aria-hidden="true" class="error">*</span></label>
                    <input id="nome" name="nome" type="text" placeholder="Inserisci nome" required />
                    <div id="nomeError" class="error" role="alert" aria-live="polite"></div>
                </div>

                <div class="field">
                    <label for="cognome">Cognome <span aria-hidden="true" class="error">*</span></label>
                    <input id="cognome" name="cognome" type="text" placeholder="Inserisci cognome" required />
                    <div id="cognomeError" class="error" role="alert" aria-live="polite"></div>
                </div>

                <div class="field" style="grid-column: 1 / -1;">
                    <label for="torneo">Torneo (opzionale)</label>
                    <input id="torneo" name="torneo" type="text"
                        placeholder="Inserisci il nome del torneo (opzionale)" />
                </div>

                <div class="field" style="grid-column: 1 / -1;">
                    <label for="immagine">Immagine Deck List (JPG/PNG) <span aria-hidden="true" class="hint">Max
                            10MB</span></label>
                    <input id="immagine" name="immagine" type="file" accept="image/*" />
                    <div id="immagineError" class="error" role="alert" aria-live="polite"></div>
                    <div id="uploadStatus" class="hint" style="margin-top:6px; display:none;">Caricamento...</div>
                    <div id="uploadProgress"
                        style="height:4px; background:#1f2937; border-radius:2px; overflow:hidden; display:none;">
                        <div id="uploadProgressBar"
                            style="height:100%; width:0%; background:#2563eb; transition: width .25s;"></div>
                    </div>
                </div>

                <div class="preview" id="previewWrapper" hidden>
                    <img id="previewImg" alt="Anteprima immagine" />
                    <div class="hint">Anteprima immagine caricata</div>
                </div>

                <div class="actions">
                    <button type="submit" class="btn btn-primary" id="submitBtn">Aggiungi Scheda</button>
                    <button type="submit" class="btn btn-secondary" id="submitAddAnotherBtn">Salva e aggiungi
                        un'altra</button>
                    <button type="button" class="btn btn-secondary" id="resetBtn">Reset</button>
                    <div class="hint">I campi contrassegnati con * sono obbligatori.</div>
                </div>

                <div id="formFeedback" class="banner" hidden aria-live="polite"></div>
            </form>
        </section>

        <section aria-labelledby="gridTitle" style="margin-top: 24px;">
            <h2 id="gridTitle" class="sr-only">Elenco schede</h2>
            <div id="grid" class="grid"></div>
        </section>
    </div>

    <!-- Modal visualizzazione dettagli e immagine -->
    <div id="modal" aria-hidden="true"
        style="position:fixed; inset:0; display:none; align-items:center; justify-content:center; background: rgba(0,0,0,0.8); z-index:1000;">
        <div id="modalDialog" class="panel" role="dialog" aria-modal="true" aria-labelledby="modalTitle"
            style="width:100%; height:100%; border-radius:0; display:flex; flex-direction:column;">
            <div
                style="display:flex; align-items:center; justify-content:space-between; padding:12px; gap:8px; border-bottom:1px solid rgba(255,255,255,0.06);">
                <div id="modalTitle" class="title" style="font-size:1.2rem;">Dettaglio scheda</div>
                <div style="display:flex; gap:8px;">
                    <button id="prevBtn" class="btn btn-secondary" title="Precedente">◀</button>
                    <button id="nextBtn" class="btn btn-secondary" title="Successivo">▶</button>
                    <button id="closeBtn" class="btn btn-danger" title="Chiudi">Chiudi</button>
                </div>
            </div>
            <div style="display:flex; flex:1; overflow:auto; padding: 16px;">
                <div
                    style="margin:auto; max-width: min(1800px, 98vw); width: 100%; display:grid; grid-template-columns: 2fr 1fr; gap:16px; align-items:center;">
                    <div
                        style="background:#0a0f1a; border:1px solid rgba(255,255,255,0.06); border-radius:12px; position:relative; min-height: 70vh; height: 70vh; overflow:hidden;">
                        <div id="imgViewport"
                            style="position:absolute; inset:0; display:flex; align-items:center; justify-content:center; touch-action: none; cursor: grab;">
                            <img id="modalImg" alt="Immagine grande"
                                style="max-width:none; max-height:none; transform-origin:center center; border-radius:12px; user-select:none; pointer-events:none;" />
                        </div>
                        <div style="position:absolute; bottom:10px; right:10px; display:flex; gap:8px;">
                            <button id="zoomOutBtn" class="btn btn-secondary" title="Zoom -">-</button>
                            <button id="zoomResetBtn" class="btn btn-secondary" title="Reset">100%</button>
                            <button id="zoomInBtn" class="btn btn-secondary" title="Zoom +">+</button>
                            <button id="fitBtn" class="btn btn-secondary" title="Adatta allo schermo">Adatta</button>
                            <button id="fsBtn" class="btn btn-secondary" title="Schermo intero">Full</button>
                            <button id="rotateLeftBtn" class="btn btn-secondary" title="Ruota a sinistra">⟲</button>
                            <button id="rotateRightBtn" class="btn btn-secondary" title="Ruota a destra">⟳</button>
                            <button id="focusBtn" class="btn btn-secondary" title="Focus immagine">Focus</button>
                            <a id="downloadBtn" class="btn btn-primary" title="Scarica immagine" download>Scarica</a>
                        </div>
                    </div>
                    <div id="detailsCol" style="display:flex; flex-direction:column; gap:14px;">
                        <div>
                            <div class="hint">Nome</div>
                            <div id="modalNome" style="font-weight:800; font-size:1.6rem;"></div>
                        </div>
                        <div>
                            <div class="hint">Cognome</div>
                            <div id="modalCognome" style="font-weight:800; font-size:1.6rem;"></div>
                        </div>
                        <div class="hint" id="modalMeta"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // ============================
        // Costanti e utilità
        // ============================
        const MAX_IMAGE_BYTES = 10 * 1024 * 1024; // 10MB

        // ===== Supabase Client (cloud DB) =====
        const SUPABASE_URL = "https://gjptnqegyqbsmnywigqj.supabase.co";
        const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdqcHRucWVneXFic21ueXdpZ3FqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1Mzk1NDMsImV4cCI6MjA3NjExNTU0M30.Yx4dGkGh2tBTW1e_8yRxnO9geJ9_0tMiXMuhHGugsC4";
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

        // Stato UI per filtro/ordinamento e lista visibile
        let state = {
            query: "",
            sort: "recent-desc", // default
            viewIds: [], // ids attualmente visibili (dopo filtro/sort)
            modalIndex: -1
        };

        // Cache in memoria delle schede (popolata da Supabase)
        let cache = [];
        async function refreshCache() {
            const { data, error } = await supabase.from('cards').select('*');
            if (error) { console.error(error); cache = []; return; }
            cache = (data || []).map(row => ({
                id: row.id,
                nome: row.nome,
                cognome: row.cognome,
                torneo: row.torneo || "",
                image_url: row.image_url || row.image_base64 || "",
                delete_hash: row.delete_hash || null,
                viewerState: row.viewer_state || undefined,
                createdAt: row.created_at ? new Date(row.created_at).getTime() : Date.now()
            }));
        }

        /**
         * Genera un ID semplice basato su timestamp e random per identificare la scheda.
         */
        function generateId() {
            return `${Date.now()}_${Math.random().toString(36).slice(2, 9)}`;
        }

        /**
         * Mostra un messaggio di feedback nel form.
         * @param {string} message
         * @param {"success"|"error"} type
         */
        function showFeedback(message, type) {
            const el = document.getElementById("formFeedback");
            el.textContent = message;
            el.className = `banner ${type}`;
            el.hidden = false;
            // Nasconde il messaggio dopo 3.5s
            window.clearTimeout(el._t);
            el._t = window.setTimeout(() => (el.hidden = true), 3500);
        }

        /**
         * Legge le schede da localStorage.
         * @returns {Array<{id:string,nome:string,cognome:string,imageBase64?:string}>}
         */
        // Le funzioni di caricamento/salvataggio sono ora gestite da IndexedDB + cache

        /**
         * Converte un File immagine in stringa Base64.
         * Valida dimensione e tipo base immagine.
         * @param {File} file
         * @returns {Promise<string>} base64 (data URL)
         */
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                if (!file) return resolve("");
                if (file.size > MAX_IMAGE_BYTES) {
                    return reject(new Error("L'immagine supera il limite di 10MB."));
                }
                if (!file.type.startsWith("image/")) {
                    return reject(new Error("Il file selezionato non è un'immagine valida."));
                }
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = () => reject(new Error("Errore durante la lettura dell'immagine."));
                reader.readAsDataURL(file);
            });
        }

        /**
         * Pulisce errori del form.
         */
        function clearFormErrors() {
            document.getElementById("nomeError").textContent = "";
            document.getElementById("cognomeError").textContent = "";
            document.getElementById("immagineError").textContent = "";
        }

        /**
         * Valida i campi del form. Ritorna true se valido.
         */
        function validateForm() {
            clearFormErrors();
            const nome = document.getElementById("nome").value.trim();
            const cognome = document.getElementById("cognome").value.trim();
            let valid = true;

            if (!nome) {
                document.getElementById("nomeError").textContent = "Il nome è obbligatorio.";
                valid = false;
            }
            if (!cognome) {
                document.getElementById("cognomeError").textContent = "Il cognome è obbligatorio.";
                valid = false;
            }
            return valid;
        }

        /**
         * Resetta il form allo stato iniziale.
         */
        function resetForm() {
            document.getElementById("cardForm").reset();
            document.getElementById("editingId").value = "";
            document.getElementById("submitBtn").textContent = "Aggiungi Scheda";
            document.getElementById("previewWrapper").hidden = true;
            clearFormErrors();
        }

        /**
         * Esegue il render della griglia di schede.
         */
        function renderGrid() {
            const grid = document.getElementById("grid");
            const visible = getVisibleCards();
            grid.innerHTML = "";
            updateResultsInfo(visible.length);
            if (!visible.length) {
                const empty = document.createElement("div");
                empty.className = "panel";
                empty.style.gridColumn = "1 / -1";
                empty.style.padding = "16px";
                empty.textContent = "Nessuna scheda presente. Aggiungine una dal form sopra.";
                grid.appendChild(empty);
                return;
            }

            for (const card of visible) {
                const el = document.createElement("article");
                el.className = "card";
                el.style.cursor = "pointer";
                el.addEventListener("click", (ev) => {
                    // evita trigger se si cliccano i pulsanti azione
                    const target = ev.target;
                    if (target.closest && target.closest('.card-actions')) return;
                    openModalById(card.id);
                });

                const img = document.createElement("img");
                img.alt = `Immagine di ${card.nome} ${card.cognome}`;
                img.src = card.image_url || "";
                img.style.cursor = "zoom-in";
                img.addEventListener("click", () => openModalById(card.id));
                el.appendChild(img);

                const body = document.createElement("div");
                body.className = "card-body";
                const title = document.createElement("div");
                title.className = "card-title";
                title.textContent = `${card.nome} ${card.cognome}`;
                const sub = document.createElement("div");
                sub.className = "card-sub";
                sub.textContent = card.torneo ? `Torneo: ${card.torneo}` : (card.image_url ? "Immagine caricata" : "Nessuna immagine");

                const actions = document.createElement("div");
                actions.className = "card-actions";
                const viewBtn = document.createElement("button");
                viewBtn.className = "btn btn-primary";
                viewBtn.textContent = "Apri";
                viewBtn.addEventListener("click", (e) => { e.stopPropagation(); openModalById(card.id); });
                const editBtn = document.createElement("button");
                editBtn.className = "btn btn-secondary";
                editBtn.textContent = "Modifica";
                editBtn.addEventListener("click", (e) => { e.stopPropagation(); startEdit(card.id); });
                const delBtn = document.createElement("button");
                delBtn.className = "btn btn-danger";
                delBtn.textContent = "Elimina";
                delBtn.addEventListener("click", (e) => { e.stopPropagation(); deleteCard(card.id); });
                actions.appendChild(viewBtn);
                actions.appendChild(editBtn);
                actions.appendChild(delBtn);

                body.appendChild(title);
                body.appendChild(sub);
                body.appendChild(actions);
                el.appendChild(body);

                grid.appendChild(el);
            }
        }

        function updateResultsInfo(n) {
            const el = document.getElementById("resultsInfo");
            if (el) el.textContent = `${n} risultato${n === 1 ? "" : "i"}`;
        }

        function getVisibleCards() {
            const all = cache;
            const q = state.query.trim().toLowerCase();
            let filtered = q
                ? all.filter(c => `${c.nome} ${c.cognome}`.toLowerCase().includes(q))
                : all.slice();
            const [key, dir] = state.sort.split("-");
            filtered.sort((a, b) => {
                let cmp = 0;
                if (key === "recent") cmp = (a.createdAt || 0) - (b.createdAt || 0);
                if (key === "nome") cmp = a.nome.localeCompare(b.nome, "it", { sensitivity: "base" });
                if (key === "cognome") cmp = a.cognome.localeCompare(b.cognome, "it", { sensitivity: "base" });
                return dir === "asc" ? cmp : -cmp;
            });
            state.viewIds = filtered.map(c => c.id);
            return filtered;
        }

        /**
         * Avvia la modifica di una scheda portandone i valori nel form.
         * @param {string} id
         */
        function startEdit(id) {
            const card = cache.find(c => c.id === id);
            if (!card) return;
            document.getElementById("editingId").value = id;
            document.getElementById("nome").value = card.nome;
            document.getElementById("cognome").value = card.cognome;
            document.getElementById("submitBtn").textContent = "Salva Modifiche";

            const previewWrapper = document.getElementById("previewWrapper");
            const previewImg = document.getElementById("previewImg");
            if (card.image_url) {
                previewImg.src = card.image_url;
                previewWrapper.hidden = false;
            } else {
                previewWrapper.hidden = true;
            }
            window.scrollTo({ top: 0, behavior: "smooth" });
        }

        /**
         * Elimina una scheda per ID.
         * @param {string} id
         */
        async function deleteCard(id) {
            const ok = confirm("Sei sicuro di voler eliminare questa scheda?");
            if (!ok) return;
            const card = cache.find(c => c.id === id);
            if (card && card.delete_hash) {
                try { await deleteFromImgur(card.delete_hash); } catch (e) { console.warn('Imgur delete error', e); }
            }
            const { error } = await supabase.from('cards').delete().eq('id', id);
            if (error) {
                console.error(error);
                showFeedback("Eliminazione negata dal database (policy).", "error");
                return;
            }
            cache = cache.filter(c => c.id !== id);
            renderGrid();
            showFeedback("Scheda eliminata.", "success");
        }

        /**
         * Gestione submit del form: crea o aggiorna una scheda.
         */
        async function handleSubmit(event) {
            event.preventDefault();
            if (!validateForm()) {
                showFeedback("Compila correttamente i campi obbligatori.", "error");
                return;
            }

            const nome = document.getElementById("nome").value.trim();
            const cognome = document.getElementById("cognome").value.trim();
            const fileInput = document.getElementById("immagine");
            const editingId = document.getElementById("editingId").value;

            // Preparazione immagine: se presente, valida e converte; se in modifica e non selezionata, mantiene esistente
            let imageUrl = "";
            let deleteHash = null;
            try {
                const file = fileInput.files && fileInput.files[0];
                if (file) {
                    const up = await uploadToImgur(file);
                    imageUrl = up.link; deleteHash = up.deletehash;
                } else if (editingId) {
                    const existing = cache.find(c => c.id === editingId);
                    imageUrl = existing?.image_url || "";
                    deleteHash = existing?.delete_hash || null;
                }
            } catch (err) {
                document.getElementById("immagineError").textContent = err.message || String(err);
                showFeedback(err.message || "Errore immagine.", "error");
                return;
            }

            if (editingId) {
                // Update
                const idx = cache.findIndex(c => c.id === editingId);
                if (idx !== -1) {
                    const torneo = document.getElementById("torneo").value.trim();
                    const updated = { ...cache[idx], nome, cognome, torneo, image_url: imageUrl, delete_hash: deleteHash };
                    const { error } = await supabase.from('cards').update({ nome, cognome, torneo, image_url: imageUrl, delete_hash: deleteHash }).eq('id', editingId);
                    if (error) { console.error(error); showFeedback("Errore aggiornamento.", "error"); return; }
                    cache[idx] = updated;
                    showFeedback("Scheda aggiornata con successo.", "success");
                }
            } else {
                // Create
                const torneo = document.getElementById("torneo").value.trim();
                const newId = generateId();
                if ((document.getElementById("immagine").files || []).length) {
                    const file = document.getElementById("immagine").files[0];
                    const up = await uploadToImgur(file);
                    imageUrl = up.link; deleteHash = up.deletehash;
                }
                const { error } = await supabase.from('cards').insert({ id: newId, nome, cognome, torneo, image_url: imageUrl, delete_hash: deleteHash });
                if (error) { console.error(error); showFeedback("Errore creazione scheda.", "error"); return; }
                const newCard = { id: newId, nome, cognome, torneo, image_url: imageUrl, delete_hash: deleteHash, createdAt: Date.now() };
                cache.unshift(newCard);
                showFeedback("Scheda creata con successo.", "success");
            }

            renderGrid();
            const submitterId = event.submitter && event.submitter.id;
            if (submitterId === "submitAddAnotherBtn") {
                // Ripulisce per nuovo inserimento mantenendo focus sul nome
                document.getElementById("nome").value = "";
                document.getElementById("cognome").value = "";
                document.getElementById("immagine").value = "";
                document.getElementById("previewWrapper").hidden = true;
                document.getElementById("editingId").value = "";
                document.getElementById("submitBtn").textContent = "Aggiungi Scheda";
                document.getElementById("nome").focus();
            } else {
                resetForm();
            }
        }

        /**
         * Gestione anteprima immagine all'input file.
         */
        async function handleImageChange() {
            document.getElementById("immagineError").textContent = "";
            const input = document.getElementById("immagine");
            const file = input.files && input.files[0];
            const previewWrapper = document.getElementById("previewWrapper");
            const previewImg = document.getElementById("previewImg");

            if (!file) {
                previewWrapper.hidden = true;
                previewImg.removeAttribute("src");
                return;
            }

            try {
                if (file.size > MAX_IMAGE_BYTES) {
                    throw new Error("L'immagine supera il limite di 10MB.");
                }
                if (!file.type.startsWith("image/")) {
                    throw new Error("Il file selezionato non è un'immagine valida.");
                }
                const base64 = await fileToBase64(file);
                previewImg.src = base64;
                previewWrapper.hidden = false;
            } catch (err) {
                previewWrapper.hidden = true;
                previewImg.removeAttribute("src");
                document.getElementById("immagineError").textContent = err.message || String(err);
                showFeedback(err.message || "Errore immagine.", "error");
                // ripulisce l'input file invalido
                input.value = "";
            }
        }

        /**
         * Svuota tutte le schede salvate.
         */
        async function clearAll() {
            const ok = confirm("Confermi di voler eliminare tutte le schede? Questa azione non è reversibile.");
            if (!ok) return;
            try {
                for (const c of cache) { try { if (c.delete_hash) await deleteFromImgur(c.delete_hash); } catch (e) { console.warn('Imgur delete', e); } }
                const ids = cache.map(c => c.id);
                if (ids.length) {
                    const { error } = await supabase.from('cards').delete().in('id', ids);
                    if (error) throw error;
                }
                cache = [];
            } catch (e) { console.error(e); showFeedback("Errore durante lo svuotamento.", "error"); return; }
            renderGrid();
            showFeedback("Archivio svuotato.", "success");
        }

        // ============================
        // Bootstrap eventi
        // ============================
        document.getElementById("cardForm").addEventListener("submit", handleSubmit);
        document.getElementById("resetBtn").addEventListener("click", resetForm);
        document.getElementById("immagine").addEventListener("change", handleImageChange);
        document.getElementById("clearAllBtn").addEventListener("click", clearAll);

        // Toolbar eventi
        const searchInput = document.getElementById("searchInput");
        const sortSelect = document.getElementById("sortSelect");
        searchInput.addEventListener("input", () => { state.query = searchInput.value; renderGrid(); });
        sortSelect.addEventListener("change", () => { state.sort = sortSelect.value; renderGrid(); });

        // Modal gestione
        const modal = document.getElementById("modal");
        const modalImg = document.getElementById("modalImg");
        const modalNome = document.getElementById("modalNome");
        const modalCognome = document.getElementById("modalCognome");
        const modalMeta = document.getElementById("modalMeta");
        const prevBtn = document.getElementById("prevBtn");
        const nextBtn = document.getElementById("nextBtn");
        const closeBtn = document.getElementById("closeBtn");
        const exportBtn = document.getElementById("exportBtn");
        const importInput = document.getElementById("importInput");
        const imgViewport = document.getElementById("imgViewport");
        const zoomInBtn = document.getElementById("zoomInBtn");
        const zoomOutBtn = document.getElementById("zoomOutBtn");
        const zoomResetBtn = document.getElementById("zoomResetBtn");
        const fitBtn = document.getElementById("fitBtn");
        const fsBtn = document.getElementById("fsBtn");
        const rotateLeftBtn = document.getElementById("rotateLeftBtn");
        const rotateRightBtn = document.getElementById("rotateRightBtn");
        const focusBtn = document.getElementById("focusBtn");
        const detailsCol = document.getElementById("detailsCol");
        const downloadBtn = document.getElementById("downloadBtn");
        let zoom = 1;
        let translateX = 0;
        let translateY = 0;
        let rotation = 0; // gradi
        let isPanning = false;
        let startX = 0, startY = 0;

        function openModalById(id) {
            const idx = state.viewIds.indexOf(id);
            if (idx === -1) return;
            openModalByIndex(idx);
        }
        function openModalByIndex(idx) {
            state.modalIndex = idx;
            showModalCard(idx);
            modal.style.display = "flex";
            modal.setAttribute("aria-hidden", "false");
            document.addEventListener("keydown", onModalKey);
            // Chiudi cliccando backdrop
            modal.addEventListener("click", onBackdropClick);
            resetZoom();
            // ripristina viewerState per la card se presente
            const id = state.viewIds[idx];
            const card = cache.find(c => c.id === id);
            if (card && card.viewerState) {
                const vs = card.viewerState;
                zoom = typeof vs.zoom === 'number' ? vs.zoom : 1;
                translateX = typeof vs.translateX === 'number' ? vs.translateX : 0;
                translateY = typeof vs.translateY === 'number' ? vs.translateY : 0;
                rotation = typeof vs.rotation === 'number' ? vs.rotation : 0;
                applyTransform();
                zoomResetBtn.textContent = `${Math.round(zoom * 100)}%`;
            }
        }
        function onBackdropClick(e) {
            if (e.target === modal) closeModal();
        }
        async function closeModal() {
            // salva stato viewer sulla card corrente
            if (state.modalIndex >= 0) {
                const id = state.viewIds[state.modalIndex];
                const idx = cache.findIndex(c => c.id === id);
                if (idx !== -1) {
                    cache[idx].viewerState = { zoom, translateX, translateY, rotation };
                    try { await dbPut(cache[idx]); } catch (_) { }
                }
            }
            modal.style.display = "none";
            modal.setAttribute("aria-hidden", "true");
            document.removeEventListener("keydown", onModalKey);
            modal.removeEventListener("click", onBackdropClick);
            state.modalIndex = -1;
        }
        function onModalKey(e) {
            if (e.key === "Escape") return closeModal();
            if (e.key === "ArrowRight") return nextModal();
            if (e.key === "ArrowLeft") return prevModal();
        }
        function showModalCard(idx) {
            const id = state.viewIds[idx];
            const card = cache.find(c => c.id === id);
            if (!card) return;
            modalImg.src = card.image_url || "";
            updateDownloadLink();
            modalNome.textContent = card.nome;
            modalCognome.textContent = card.cognome;
            const date = new Date(card.createdAt || Date.now());
            const torneoInfo = card.torneo ? ` • Torneo: ${card.torneo}` : "";
            modalMeta.textContent = `Creata il ${date.toLocaleDateString('it-IT')} alle ${date.toLocaleTimeString('it-IT')}${torneoInfo}`;
            prevBtn.disabled = state.viewIds.length <= 1;
            nextBtn.disabled = state.viewIds.length <= 1;
        }
        function nextModal() {
            if (state.modalIndex < 0) return;
            state.modalIndex = (state.modalIndex + 1) % state.viewIds.length;
            showModalCard(state.modalIndex);
        }
        function prevModal() {
            if (state.modalIndex < 0) return;
            state.modalIndex = (state.modalIndex - 1 + state.viewIds.length) % state.viewIds.length;
            showModalCard(state.modalIndex);
        }
        prevBtn.addEventListener("click", prevModal);
        nextBtn.addEventListener("click", nextModal);
        closeBtn.addEventListener("click", closeModal);

        function applyTransform() {
            modalImg.style.transform = `translate(${translateX}px, ${translateY}px) scale(${zoom}) rotate(${rotation}deg)`;
        }
        function resetZoom() {
            zoom = 1; translateX = 0; translateY = 0; rotation = 0; applyTransform();
            zoomResetBtn.textContent = `${Math.round(zoom * 100)}%`;
        }
        function setZoom(newZoom, centerX, centerY) {
            newZoom = Math.min(5, Math.max(0.5, newZoom));
            // zoom relativo al punto di centro se fornito
            const rect = imgViewport.getBoundingClientRect();
            const cx = centerX ?? rect.width / 2;
            const cy = centerY ?? rect.height / 2;
            const prevZoom = zoom;
            zoom = newZoom;
            // mantieni il punto sotto il cursore
            translateX = (translateX - cx) * (zoom / prevZoom) + cx;
            translateY = (translateY - cy) * (zoom / prevZoom) + cy;
            applyTransform();
            zoomResetBtn.textContent = `${Math.round(zoom * 100)}%`;
        }
        // Zoom buttons
        zoomInBtn.addEventListener("click", (e) => { e.stopPropagation(); setZoom(zoom + 0.2); });
        zoomOutBtn.addEventListener("click", (e) => { e.stopPropagation(); setZoom(zoom - 0.2); });
        zoomResetBtn.addEventListener("click", (e) => { e.stopPropagation(); resetZoom(); });
        // Fit to viewport
        function fitToViewport() {
            const vp = imgViewport.getBoundingClientRect();
            const natural = getImageNaturalSize(modalImg);
            if (!natural) return resetZoom();
            const scale = Math.min(vp.width / natural.width, vp.height / natural.height);
            zoom = Math.max(0.5, Math.min(5, scale));
            translateX = vp.width / 2; // center
            translateY = vp.height / 2;
            // After centering, offset by half image size at scale
            translateX -= (natural.width * zoom) / 2;
            translateY -= (natural.height * zoom) / 2;
            applyTransform();
            zoomResetBtn.textContent = `${Math.round(zoom * 100)}%`;
        }
        fitBtn.addEventListener("click", (e) => { e.stopPropagation(); fitToViewport(); });
        function getImageNaturalSize(img) { if (!img.complete) return null; return { width: img.naturalWidth, height: img.naturalHeight }; }
        // Fullscreen toggle
        fsBtn.addEventListener("click", async (e) => {
            e.stopPropagation();
            const el = document.getElementById("modalDialog");
            try {
                if (!document.fullscreenElement) {
                    await el.requestFullscreen();
                } else {
                    await document.exitFullscreen();
                }
            } catch (_) { }
        });
        // Wheel zoom
        imgViewport.addEventListener("wheel", (e) => {
            e.preventDefault();
            const delta = Math.sign(e.deltaY);
            const factor = delta > 0 ? -0.15 : 0.15;
            setZoom(zoom + factor, e.offsetX, e.offsetY);
        }, { passive: false });
        // Pan drag
        imgViewport.addEventListener("pointerdown", (e) => {
            isPanning = true; imgViewport.setPointerCapture(e.pointerId); startX = e.clientX - translateX; startY = e.clientY - translateY; imgViewport.style.cursor = "grabbing";
        });
        imgViewport.addEventListener("pointermove", (e) => {
            if (!isPanning) return; translateX = e.clientX - startX; translateY = e.clientY - startY; applyTransform();
        });
        imgViewport.addEventListener("pointerup", (e) => { isPanning = false; imgViewport.releasePointerCapture(e.pointerId); imgViewport.style.cursor = "grab"; });
        // Double-click zoom
        imgViewport.addEventListener("dblclick", (e) => {
            e.preventDefault();
            const targetZoom = zoom < 2 ? zoom + 0.8 : 1;
            setZoom(targetZoom, e.offsetX, e.offsetY);
        });
        // Rotazione
        rotateLeftBtn.addEventListener("click", (e) => { e.stopPropagation(); rotation = (rotation - 90) % 360; applyTransform(); });
        rotateRightBtn.addEventListener("click", (e) => { e.stopPropagation(); rotation = (rotation + 90) % 360; applyTransform(); });
        // Focus immagine: nasconde dettagli e allarga a 100%
        let focusOn = false;
        focusBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            focusOn = !focusOn;
            detailsCol.style.display = focusOn ? "none" : "flex";
            const container = detailsCol.parentElement;
            container.style.gridTemplateColumns = focusOn ? "1fr" : "2fr 1fr";
            focusBtn.textContent = focusOn ? "Dettagli" : "Focus";
        });
        // Download immagine
        function updateDownloadLink() {
            if (!modalImg.src) return; downloadBtn.href = modalImg.src;
        }

        // Export/Import JSON
        exportBtn.addEventListener("click", async () => {
            try {
                const { data: rows } = await supabase.from('cards').select('*');
                const data = (rows || []).map(r => ({ id: r.id, nome: r.nome, cognome: r.cognome, torneo: r.torneo, image_url: r.image_url || r.image_base64, viewerState: r.viewer_state, created_at: r.created_at }));
                const blob = new Blob([JSON.stringify({ version: 2, exportedAt: Date.now(), items: data }, null, 2)], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = `decklist-backup-${new Date().toISOString().slice(0, 19).replace(/[:T]/g, '-')}.json`;
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(url);
            } catch (e) {
                console.error(e);
                showFeedback("Errore durante l'esportazione.", "error");
            }
        });

        importInput.addEventListener("change", async () => {
            const file = importInput.files && importInput.files[0];
            if (!file) return;
            try {
                const text = await file.text();
                const json = JSON.parse(text);
                if (!json || !Array.isArray(json.items)) throw new Error("Formato JSON non valido.");
                const items = json.items;
                const seen = new Set();
                const toPut = [];
                for (const it of items) {
                    if (!it || typeof it !== "object") continue;
                    const id = String(it.id || "").trim();
                    const nome = String(it.nome || "").trim();
                    const cognome = String(it.cognome || "").trim();
                    if (!id || !nome || !cognome) continue;
                    if (seen.has(id)) continue;
                    seen.add(id);
                    const image_url = typeof it.image_url === "string" ? it.image_url : "";
                    const torneo = typeof it.torneo === "string" ? it.torneo : "";
                    const viewer_state = typeof it.viewerState === "object" && it.viewerState ? it.viewerState : null;
                    toPut.push({ id, nome, cognome, torneo, image_url, viewer_state });
                }
                if (!toPut.length) throw new Error("Nessuna scheda valida trovata nel file.");
                for (const row of toPut) {
                    await supabase.from('cards').upsert(row, { onConflict: 'id' });
                }
                await refreshCache();
                renderGrid();
                showFeedback(`Import completato: ${toPut.length} schede.`, "success");
            } catch (e) {
                console.error(e);
                showFeedback(e.message || "Errore durante l'import.", "error");
            } finally {
                importInput.value = "";
            }
        });

        // Upload via Imgur (come cafe.html)
        async function uploadToImgur(file) {
            const clientId = '06127cb96dfdf99';
            const formData = new FormData();
            formData.append('image', file);
            // UI progress fittizio
            const statusEl = document.getElementById('uploadStatus');
            const barWrap = document.getElementById('uploadProgress');
            const bar = document.getElementById('uploadProgressBar');
            if (statusEl && barWrap) { statusEl.style.display = 'block'; barWrap.style.display = 'block'; bar.style.width = '0%'; statusEl.textContent = 'Caricamento su Imgur...'; }

            let progress = 0;
            const timer = setInterval(() => { progress = Math.min(90, progress + 5); bar.style.width = progress + '%'; }, 120);

            const resp = await fetch('https://api.imgur.com/3/image', {
                method: 'POST',
                headers: { 'Authorization': `Client-ID ${clientId}` },
                body: formData
            });
            const data = await resp.json();
            clearInterval(timer);
            if (statusEl && barWrap) { bar.style.width = '100%'; statusEl.textContent = data.success ? 'Caricamento completato!' : 'Errore upload'; }
            if (data && data.success && data.data && data.data.link) {
                setTimeout(() => { if (statusEl && barWrap) { barWrap.style.display = 'none'; statusEl.style.display = 'none'; } }, 1200);
                return { link: data.data.link, deletehash: data.data.deletehash };
            }
            throw new Error('Upload Imgur fallito');
        }

        async function deleteFromImgur(deleteHash) {
            const clientId = '06127cb96dfdf99';
            await fetch(`https://api.imgur.com/3/image/${deleteHash}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Client-ID ${clientId}` }
            });
        }

        // Bootstrap iniziale: migrazione e caricamento cache, poi render
        (async function bootstrap() {
            await refreshCache();
            renderGrid();
        })();
    </script>
</body>

</html>